<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Minimal Glimmer Rendering</title>
    <script type="module">
      import {
        runtimeOptions,
        NewTreeBuilder,
        renderComponent,
        renderSync,
        on,
      } from "@glimmer/runtime";
      import { EvaluationContextImpl, templateFactory } from "@glimmer/opcode-compiler";
      import { artifacts, RuntimeOpImpl } from "@glimmer/program";
      import { setComponentTemplate, setInternalComponentManager } from "@glimmer/manager";
      import { precompile, precompileJSON } from "@glimmer/compiler";
      import { trackedData } from "@glimmer/validator";
      import { preprocess, getTemplateLocals } from "@glimmer/syntax";
      import boilerplateComponentManager from "./boilerplate-example-component-manager";

      const scheduledDestructors = [];
      const scheduledFinalizers = [];

      function flush(queue) {
        for (const fn of queue) fn();
        queue.length = 0;
      }

      function createEnvDelegate(isInteractive) {
        return {
          isInteractive: true,
          enableDebugTooling: false,
          onTransactionCommit() {
            flush(scheduledDestructors);
            flush(scheduledFinalizers);
          },
        };
      }

      class Counter {
        #data = trackedData({ count: 0 });

        get count() {
          return this.#data["count"];
        }

        increment = () => this.#data["count"]++;

        static {
          setInternalComponentManager(boilerplateComponentManager, this);
          setComponentTemplate(
            /* Custom Compile Template because Glimmer Standalone is very unergonomic */
            createTemplate(
              `<p>You have clicked the button {{this.count}} times.</p>

              <button {{on "click" this.increment}}>Click</button>`,
              { on },
            ),
            this,
          );
        }
      }

      /**
       *
       * Copied from @glimmer-workspace/integration-tests/lib/compile
       *
       * We don't have a good way to do runtime compilation in glimmer.
       */
      function createTemplate(templateSource, scopeValues = {}) {
        let options = {};
        options.locals = Object.keys(scopeValues ?? {});
        let [block, usedLocals] = precompileJSON(templateSource, { strictMode: true, ...options });
        let reifiedScopeValues = usedLocals.map((key) => scopeValues[key]);

        let templateBlock = {
          id: `id-${Date.now()}`,
          block: JSON.stringify(block),
          moduleName: options.meta?.moduleName ?? "(unknown template module)",
          scope: reifiedScopeValues.length > 0 ? () => reifiedScopeValues : null,
          isStrictMode: true,
        };

        return templateFactory(templateBlock);
      }

      function render() {
        const element = document.body;
        const sharedArtifacts = artifacts();
        const envDelegate = createEnvDelegate();
        const components = new Map();
        const helpers = new Map();
        const modifiers = new Map();

        const resolver = {
          lookupHelper: (name) => helpers.get(name) ?? null,
          lookupModifier: (name) => modifiers.get(name) ?? null,
          lookupComponent: (name) => components.get(name) ?? null,

          lookupBuiltInHelper: () => null,
          lookupBuiltInModifier: () => null,
        };

        const runtime = runtimeOptions({ document }, envDelegate, sharedArtifacts, resolver);

        const context = new EvaluationContextImpl(
          sharedArtifacts,
          (heap) => new RuntimeOpImpl(heap),
          runtime,
        );

        const env = context.env;
        const cursor = { element, nextSibling: null };
        const treeBuilder = NewTreeBuilder.forInitialRender(env, cursor);

        renderSync(env, renderComponent(context, treeBuilder, {}, Counter, {}));
      }

      render();
    </script>
  </head>
  <body></body>
</html>
